
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Example of CVA computation &#8212; Quantlib cython wrapper 0.1.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Reference guide" href="../reference_guide.html" />
    <link rel="prev" title="Risk Factors in USD Libor Market" href="LiborRiskFactors.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Example-of-CVA-computation">
<h1>Example of CVA computation<a class="headerlink" href="#Example-of-CVA-computation" title="Permalink to this headline">¶</a></h1>
<p>This example is taken from the following website: <a class="reference external" href="http://www.pricederivatives.com/en/derivatives-cva-example-monte-carlo-python/">http://www.pricederivatives.com/en/derivatives-cva-example-monte-carlo-python/</a>. We’ve taken advantage of some functionalities provided by pyql to simplify the computations.</p>
<p>Here we’ll show an example of code for CVA calculation (credit valuation adjustment) with Python and Quantlib using a simple Monte-Carlo method for a portfolio consisting solely of a single interest rate swap. It’s easy to generalize this code to include more financial instruments.</p>
<section id="CVA-calculation-algorithm">
<h2>CVA calculation algorithm<a class="headerlink" href="#CVA-calculation-algorithm" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Simulate yield curve at future dates.</p></li>
<li><p>Calculate your derivatives portfolio NPV (net present value) at each time point for each scenario.</p></li>
<li><p>Calculate CVA as sum of Expected Exposure multiplied by probability of default at this interval</p>
<div class="math">
<p><span class="math">CVA = (1-R) \int{DF(t) EE(t) dQ_t}</span></p>
</div><p>where <span class="math">R</span> is the Recovery (normally set to 40%), <span class="math">EE(t)</span> the expected exposure at time <span class="math">t</span>, <span class="math">dQ</span> the survival probability density, and <span class="math">DF(t)</span> discount factor at time <span class="math">t</span>.</p>
</li>
</ol>
</section>
<section id="Outline">
<h2>Outline<a class="headerlink" href="#Outline" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>In this simple example, we will use the Hull White model to generate future yield curves. In practice, many banks use some yield curve evolution models based on historical simulations. In the Hull White model, the short rate <span class="math">r_t</span> is distributed normally with known mean and variance.</p></li>
<li><p>For each point of time we will generate whole yield curve based on short rate. Then we will price our interest rate swap on each of these curves.</p></li>
<li><p>to approximate CVA we will use BASEL III formula for regulatory capital charge approximating default probability [or survival probability ] as exp(-ST/(1-R)) so we get:</p>
<div class="math">
<p><span class="math">CVA= (1-R) \sum \frac{EE^{*}_{T_{i}}+EE^{*}_{T_{i-1}}}{2} (e^{-\frac{ST_{i-1}}{1-R}}-e^{-\frac{ST_{i}}{1-R}})^+</span></p>
</div><p>where <span class="math">EE^{*}</span> is discounted Expected exposure of portfolio.</p>
</li>
</ol>
</section>
<section id="Hull-White-model-for-future-yield-curve-simulations">
<h2>Hull-White model for future yield curve simulations<a class="headerlink" href="#Hull-White-model-for-future-yield-curve-simulations" title="Permalink to this headline">¶</a></h2>
<p>the model is given by dynamics:</p>
<div class="math">
<p><span class="math">dr_t=(\theta_t-ar_t)dt+\sigma dW_t</span></p>
</div><p>In the Hull White model, the short rate <span class="math">r_t</span> is distributed normally with mean and variance given by</p>
<div class="math">
<p><span class="math">E(r_t|r_s)=r_se^{-a(t-s)}+\gamma_t-\gamma_se^{-a(t-s)}</span></p>
</div><div class="math">
<p><span class="math">Var(r_t|r_s)=\frac{\sigma^2}{2a}(1-e^{-2a(t-s)})</span></p>
</div><p>where <span class="math">\gamma_t=f_t(0)+\frac{\sigma^2}{2a}(1-e^{-at})^2</span> and <span class="math">f_t(0)</span> is the instantaneous forward rate at time <span class="math">t</span> as seen at time 0. The calculations will not depend on <span class="math">\theta_t</span>. To generate the future values of <span class="math">r_t</span>, we use the <a class="reference internal" href="../_autosummary/quantlib.sim.simulate.simulate_process.html#quantlib.sim.simulate.simulate_process"><span class="std std-ref">simulate_process</span></a> function which is a convenience function provided in the simulate module of pyql. After getting a matrix of all
<span class="math">r_t</span> for all draws and time points, we will construct a yield curve for each <span class="math">r_t</span> using Hull White discount factors <span class="math">E(r_{t_i})</span> at each future date.</p>
<div class="math">
<p><span class="math">P_{\rightarrow T}(0)= E( e^{-\int_0^Tr_sds})=E( E(e^{-\int_0^Tr_sds}|\mathcal{F}_{t_i}))=E(P_{\rightarrow t_i}(0)E(e^{-\int_{t_i}^Tr_sds}|\mathcal{F}_{t_i}))</span></p>
</div><p>for each future time point <span class="math">t_i</span>, <span class="math">T</span> being the maturity.</p>
<p>also we’ll output some generated yield curves.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from quantlib.settings import Settings
from quantlib.time.api import (Date, Actual360, TARGET, NoFrequency, Period,
                               Years, Schedule, ModifiedFollowing, Following, Rule)
from quantlib.termstructures.yields.api import DiscountCurve

todaysDate = Date(26, 12, 2013);
Settings().evaluation_date = todaysDate;
crvTodaydates = [Date(26, 12, 2013),
                 Date(30, 6, 2014),
                 Date(30, 7, 2014),
                 Date(29, 8, 2014),
                 Date(30, 9, 2014),
                 Date(30, 10, 2014),
                 Date(28, 11, 2014),
                 Date(30, 12, 2014),
                 Date(30, 1, 2015),
                 Date(27, 2, 2015),
                 Date(30, 3, 2015),
                 Date(30, 4, 2015),
                 Date(29, 5, 2015),
                 Date(30, 6, 2015),
                 Date(30, 12, 2015),
                 Date(30, 12, 2016),
                 Date(29, 12, 2017),
                 Date(31, 12, 2018),
                 Date(30, 12, 2019),
                 Date(30, 12, 2020),
                 Date(30, 12, 2021),
                 Date(30, 12, 2022),
                 Date(29, 12, 2023),
                 Date(30, 12, 2024),
                 Date(30, 12, 2025),
                 Date(29, 12, 2028),
                 Date(30, 12, 2033),
                 Date(30, 12, 2038),
                 Date(30, 12, 2043),
                 Date(30, 12, 2048),
                 Date(30, 12, 2053),
                 Date(30, 12, 2058),
                 Date(31, 12, 2063)]
crvTodaydf=[1.0,
            0.998022,
            0.99771,
            0.99739,
            0.997017,
            0.996671,
            0.996337,
            0.995921,
            0.995522,
            0.995157,
            0.994706,
            0.994248,
            0.993805,
            0.993285,
            0.989614,
            0.978541,
            0.961973,
            0.940868,
            0.916831,
            0.890805,
            0.863413,
            0.834987,
            0.807111,
            0.778332,
            0.750525,
            0.674707,
            0.575192,
            0.501258,
            0.44131,
            0.384733,
            0.340425,
            0.294694,
            0.260792
            ]

crvToday = DiscountCurve(crvTodaydates, crvTodaydf, Actual360(), TARGET())
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import numpy as np
months = range(3, 12 * 5 + 1, 3)
sPeriods = [&quot;{}M&quot;.format(month) for month in months]
print(sPeriods)

Dates = [todaysDate] + [todaysDate + Period(s) for s in sPeriods]
T = np.array([Actual360().year_fraction(todaysDate, d) for d in Dates])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;3M&#39;, &#39;6M&#39;, &#39;9M&#39;, &#39;12M&#39;, &#39;15M&#39;, &#39;18M&#39;, &#39;21M&#39;, &#39;24M&#39;, &#39;27M&#39;, &#39;30M&#39;, &#39;33M&#39;, &#39;36M&#39;, &#39;39M&#39;, &#39;42M&#39;, &#39;45M&#39;, &#39;48M&#39;, &#39;51M&#39;, &#39;54M&#39;, &#39;57M&#39;, &#39;60M&#39;]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from matplotlib import pyplot as plt
import matplotlib
matplotlib.rcParams[&#39;figure.figsize&#39;] = (15.0, 7.0)

from quantlib.processes.api import HullWhiteProcess
from quantlib.sim.simulate import simulate_process
from quantlib.time_grid import TimeGrid

Nsim = 1000

#parameters calibrated with Quantlib to coterminal swaptions on 26/dec/2013
a = 0.376739
sigma = 0.0209835

hw = HullWhiteProcess(crvToday, a, sigma)
grid = TimeGrid.from_vector(T)
rmat = simulate_process(hw, Nsim, grid, 1, antithetic=False)
dT = np.diff(T)

#check that bond prices match the original discount factors
bonds = np.empty_like(rmat)
bonds[1:] = np.exp(-(rmat[1:] * dT[:,None]).cumsum(axis=0))
bonds[0] = 1
bonds_mean = np.mean(bonds, axis=1)

fig, ax = plt.subplots(figsize=(8, 5), layout=&#39;constrained&#39;)
ax.plot(T, bonds_mean, label=&quot;simulated bond prices&quot;)
ax.plot(T, [crvToday.discount(t) for t in T], label=&quot;discount factors&quot;)
ax.set_xlabel(&quot;T&quot;)
ax.legend()
fig
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_CVA_computation_5_0.png" src="../_images/notebooks_CVA_computation_5_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "0006fdc14a97445f8960c924e58e30bd", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from quantlib.models.shortrate.onefactormodels.hullwhite import HullWhite

start_date = Date(26, 12, 2013);
hw_model = HullWhite(crvToday, a, sigma)
crvMat = np.empty((len(T), Nsim), dtype=&#39;object&#39;)
crvMat[0] = crvToday
for i in range(1, len(T)):
    crvDates = [Dates[i] + Period(k, Years) for k in range(21)]
    crv_row = []
    for n in range(Nsim):
        rt = rmat[i, n]
        crvDiscounts = [hw_model.discount_bound(T[i], T[i] + k, rt) for k in np.arange(21.)]
        crvMat[i, n] = DiscountCurve(crvDates, crvDiscounts, Actual360(), TARGET())

bondT = np.zeros_like(rmat)
for n in range(Nsim):
    for i in range(len(T)):
        bondT[i,n] = bonds[i,n] * crvMat[i,n].discount(19 - T[i])

bondTmean = np.mean(bondT, axis=1)
np.set_printoptions(precision=4, suppress=True)
print(&#39;bondTmean-Terminal bond\n&#39;, bondTmean - crvToday.discount(19.))
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
bondTmean-Terminal bond
 [0.     0.0056 0.0053 0.0048 0.0046 0.0056 0.0058 0.0065 0.0061 0.0057
 0.0053 0.0056 0.0047 0.0048 0.004  0.0041 0.004  0.0036 0.0042 0.0034
 0.004 ]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from quantlib.compounding import Continuous
fig, ax = plt.subplots(figsize=(8, 5))
ax.plot(range(10),
         [crvMat[0,0].forward_rate(t, t, compounding=Continuous, frequency=NoFrequency).rate
          for t in np.arange(10.)])
for i in range(min(Nsim, 10)):
    ax.plot(range(10), [crvMat[i,1].forward_rate(t, t,
                                                  compounding=Continuous, frequency=NoFrequency).rate
                         for t in np.arange(10.)])
ax.set_title(&#39;generated yield curves&#39;)
fig
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_CVA_computation_7_0.png" src="../_images/notebooks_CVA_computation_7_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "377e248fa76942e59e5ca7c4be322f80", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from quantlib.indexes.api import Euribor6M
from quantlib.instruments.api import VanillaSwap, Receiver
from quantlib.pricingengines.swap import DiscountingSwapEngine
from quantlib.termstructures.yields.api import YieldTermStructure

#indexes definition
forecast_term_structure = YieldTermStructure()
index = Euribor6M(forecast_term_structure)

rmean = [hw.expectation(0., hw.x0, t) for t in T]

# we add a fixing every 6 months
for i in range(0, len(Dates), 2):
    index.add_fixing(index.fixing_date(Dates[i]), rmean[i])
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>#swap 1 definition
maturity = Date(26, 12, 2018)
fixed_schedule = Schedule.from_rule(start_date, maturity, Period(&quot;6M&quot;), TARGET(),
                                    ModifiedFollowing, ModifiedFollowing, Rule.Forward,
                                    False)
floating_schedule = Schedule.from_rule(start_date, maturity, Period(&quot;6M&quot;),
                                       TARGET(), ModifiedFollowing,
                                       ModifiedFollowing, Rule.Forward, False)
swap1 = VanillaSwap(Receiver, 10_000_000, fixed_schedule, 0.02, Actual360(),
                    floating_schedule, index, 0, Actual360())  #0.01215
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>npvMat = np.empty((len(T), Nsim))

discount_term_structure = YieldTermStructure()
swapEngine = DiscountingSwapEngine(discount_term_structure)
npvMat = np.empty((len(T), Nsim))
swap1.set_pricing_engine(swapEngine)

for i, d in enumerate(Dates):
    Settings().evaluation_date = d
    for n in range(Nsim):
        crv = crvMat[i, n]
        discount_term_structure.link_to(crv)
        forecast_term_structure.link_to(crv)
        npvMat[i, n] = swap1.npv
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>npv = npvMat[0,0]
#replace negative values with 0
npvMat[npvMat&lt;0] = 0
EE = np.mean(npvMat, axis=1)
print(&#39;\nEE:\n&#39;, EE)
#print &#39;\nrmat:\n&#39;,rmat
print(&#39;\nrmean:\n&#39;, rmean)
#print &#39;\nrstd:\n&#39;,rstd
#print &#39;\n95% are in \n&#39;,zip(rmean-2*rstd,rmean+2*rstd)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

EE:
 [401670.1158 418836.1352 340293.5483 350128.0023 355742.385  301135.2662
 235679.9031 249760.1162 243312.1597 199152.445  174698.3439 144657.1733
 130173.2957 111075.2397  59332.7639  64612.5595  43032.7119  35243.9918
      0.          0.          0.    ]

rmean:
 [0.0038321783708768938, 0.0038447104458097666, 0.003878829192934586, 0.004304415296142585, 0.004854534792846587, 0.005486708976510404, 0.00618266474586651, 0.007652760916036794, 0.007726527486934385, 0.011583314187371059, 0.011655179426606066, 0.011724510502370677, 0.011790125103332274, 0.01767265729120667, 0.017732265414519513, 0.01778829449949869, 0.017840190647180572, 0.0227598814403213, 0.02280548353169784, 0.022847781363155784, 0.022886514765800076]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># We use 5% for the credit spread and 40% for the recovery
from math import exp
S = 0.05
R = 0.4
r = 0
for i in range(len(T)-1):
    r += 0.5 * crvToday.discount(T[i+1]) * (EE[i] + EE[i+1]) * (exp(-S*T[i]/(1.0-R)) -exp(-S*T[i+1]/(1.0-R)))
CVA = (1. - R) * r
print(&quot;\nnpv=&quot;, npv)
print(&quot;\nCVA=&quot;, CVA)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

npv= 401670.1157927497

CVA= 40722.15743027281
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, ax = plt.subplots(figsize=(8, 5))
ax.plot(T, EE)
ax.set_xlabel(&quot;Time in years&quot;)
ax.set_title(&#39;Expected Exposure&#39;)
fig
#plot(T,np.mean(rmat,axis=0))
#plot(T,rmean)
#plot(T,[npvMat[0,0]]*len(T))
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_CVA_computation_13_0.png" src="../_images/notebooks_CVA_computation_13_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "b6d7e2e772934950b2ae798e2aa737a6", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Quantlib cython wrapper</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">Tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../users_guide.html">User’s guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../users_guide.html#business-dates">Business dates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../users_guide.html#reference">Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../users_guide.html#mlab">Mlab</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../users_guide.html#notebooks">Notebooks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference_guide.html">Reference guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html#documentation">Documentation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../users_guide.html">User’s guide</a><ul>
      <li>Previous: <a href="LiborRiskFactors.html" title="previous chapter">Risk Factors in USD Libor Market</a></li>
      <li>Next: <a href="../reference_guide.html" title="next chapter">Reference guide</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2011, Didrik Pinte, Patrick Henaff.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/notebooks/CVA computation.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>